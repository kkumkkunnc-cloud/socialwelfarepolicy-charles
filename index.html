<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬íšŒë³µì§€ì •ì±…ë¡ (6~15ê°•) 100ë¬¸í•­ | ì˜¨ë¼ì¸ ëª¨ì˜ê³ ì‚¬</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Noto Sans KR",Inter,Roboto,"Helvetica Neue","Apple SD Gothic Neo",sans-serif}
  .option{transition:all .2s}
  .option.correct{background:#d1fae5;border-color:#34d399;color:#065f46;font-weight:600}
  .option.incorrect{background:#fee2e2;border-color:#f87171;color:#991b1b}
  .fade-in{animation:fade .2s ease}
  @keyframes fade{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
</style>
</head>
<body class="bg-slate-100 min-h-dvh p-4 sm:p-6">
  <div class="mx-auto max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
    <!-- í—¤ë” -->
    <header class="p-5 border-b bg-gradient-to-r from-indigo-50 to-blue-50">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h1 class="text-xl sm:text-2xl font-bold text-slate-800">
          ì‚¬íšŒë³µì§€ì •ì±…ë¡ (6~15ê°•) 100ë¬¸í•­ ëª¨ì˜ê³ ì‚¬
        </h1>
        <div class="flex items-center gap-2">
          <button id="btnImport" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-black">ì›ë¬¸ ë¶™ì—¬ë„£ê¸°</button>
          <button id="btnResume" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 hidden">ì¬ê°œ</button>
          <button id="btnReset" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <p class="text-slate-600 mt-2 text-sm">
        ë¶™ì—¬ë„£ê¸° â†’ ìë™ íŒŒì‹± â†’ ë¬´ì‘ìœ„ ì¶œì œ Â· ì •ë‹µ/í•´ì„¤ Â· ì˜¤ë‹µë…¸íŠ¸ Â· CSV ë‚´ë³´ë‚´ê¸° ì§€ì›
      </p>
    </header>

    <!-- ì»¨íŠ¸ë¡¤ ë°” -->
    <div class="p-4 border-b flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
      <div class="flex items-center gap-2">
        <label class="text-sm text-slate-600">ì±•í„°:</label>
        <select id="filterChapter" class="px-3 py-2 rounded border bg-white text-sm">
          <option value="all">ì „ì²´(6~15ê°•)</option>
          <option value="ì œ6ê°•">ì œ6ê°•</option>
          <option value="ì œ7ê°•">ì œ7ê°•</option>
          <option value="ì œ8ê°•">ì œ8ê°•</option>
          <option value="ì œ9ê°•">ì œ9ê°•</option>
          <option value="ì œ10ê°•">ì œ10ê°•</option>
          <option value="ì œ11ê°•">ì œ11ê°•</option>
          <option value="ì œ12ê°•">ì œ12ê°•</option>
          <option value="ì œ13ê°•">ì œ13ê°•</option>
          <option value="ì œ14ê°•">ì œ14ê°•</option>
          <option value="ì œ15ê°•">ì œ15ê°•</option>
        </select>

        <label class="text-sm text-slate-600 ml-3">ì¶œì œ:</label>
        <select id="modeSelect" class="px-3 py-2 rounded border bg-white text-sm">
          <option value="shuffle">ë¬´ì‘ìœ„(ê¶Œì¥)</option>
          <option value="ordered">ìˆœì„œëŒ€ë¡œ(Q1â†’Q100)</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnStart" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">ì‹œì‘</button>
        <button id="btnExport" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700">ê²°ê³¼ CSV</button>
        <button id="btnReview" class="px-3 py-2 rounded-lg bg-amber-500 text-white text-sm hover:bg-amber-600">ì˜¤ë‹µë…¸íŠ¸</button>
      </div>
    </div>

    <!-- ì§„í–‰ ë°” -->
    <div class="px-4 pt-4">
      <div class="flex justify-between text-xs text-slate-600 mb-1">
        <div id="progressText">ì§„í–‰ 0 / 0</div>
        <div id="chapterText">-</div>
      </div>
      <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
        <div id="progressBar" class="h-2 bg-blue-600 rounded-full transition-all" style="width:0%"></div>
      </div>
    </div>

    <!-- ë³¸ë¬¸ -->
    <main id="main" class="p-4 sm:p-6">
      <!-- ì•ˆë‚´ -->
      <div id="welcome" class="text-slate-700">
        <div class="bg-slate-50 border rounded-xl p-5">
          <h2 class="font-semibold text-lg mb-2">ì‚¬ìš© ë°©ë²•</h2>
          <ol class="list-decimal pl-5 space-y-1 text-sm">
            <li><strong>ì›ë¬¸ ë¶™ì—¬ë„£ê¸°</strong>ë¥¼ ëˆŒëŸ¬, ì§€ê¸ˆ ë©”ì‹œì§€ì— ìˆëŠ” Q1~Q100 ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê³  <em>ê°€ì ¸ì˜¤ê¸°</em>.</li>
            <li>ì±•í„°/ì¶œì œë°©ì‹ ì„ íƒ í›„ <strong>ì‹œì‘</strong>.</li>
            <li>ì •ë‹µ ì„ íƒ ì‹œ ë°”ë¡œ ì±„ì &í•´ì„¤ í‘œì‹œ. <kbd>1</kbd>~<kbd>4</kbd>, <kbd>N</kbd> í‚¤ ì§€ì›.</li>
            <li>ì§„í–‰ ìƒí™©ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤(ë¸Œë¼ìš°ì €ë§Œ ë™ì¼í•˜ë©´ ì¬ê°œ ê°€ëŠ¥).</li>
          </ol>
          <p class="mt-3 text-xs text-slate-500">* íŒŒì„œê°€ <em>ì •ë‹µ: â‘¢</em> ë˜ëŠ” <em>ì •ë‹µ: 3</em> ëª¨ë‘ ì¸ì‹. <em>í•´ì„¤:</em>ì€ ë‹¤ìŒ ë¬¸ì œ ì „ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ í•´ì„¤ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="mt-5 text-xs text-slate-500">
          í…ŒìŠ¤íŠ¸ìš© ë¯¸ë‹ˆ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆì–´, ë¶™ì—¬ë„£ê¸° ì—†ì´ë„ ë°”ë¡œ <b>ì‹œì‘</b>ì„ ëˆŒëŸ¬ ë™ì‘ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>

      <!-- ë¬¸ì œ ì˜ì—­ -->
      <section id="quiz" class="hidden">
        <h2 id="qTitle" class="text-lg sm:text-xl font-bold text-slate-900 mb-3 leading-relaxed"></h2>
        <div id="options" class="grid grid-cols-1 gap-2"></div>
        <div id="explain" class="hidden mt-5 p-4 border rounded-lg bg-blue-50 text-slate-800 fade-in">
          <h3 class="font-semibold mb-1">ì •ë‹µ ë° í•´ì„¤</h3>
          <div id="explainText" class="text-sm leading-relaxed whitespace-pre-wrap"></div>
        </div>
        <div class="mt-6 flex items-center justify-between">
          <div class="text-sm text-slate-600" id="metaText"></div>
          <button id="btnNext" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
      </section>

      <!-- ê²°ê³¼ -->
      <section id="result" class="hidden">
        <div class="text-center">
          <h2 class="text-2xl font-extrabold text-slate-900 mb-2">ê²°ê³¼</h2>
          <p class="text-slate-700 mb-4">ì´ <span id="resTotal">0</span>ë¬¸í•­ ì¤‘ <span id="resCorrect" class="font-bold text-emerald-600">0</span>ê°œ ì •ë‹µ</p>
          <div class="inline-block bg-blue-100 px-6 py-5 rounded-full text-4xl font-extrabold text-blue-700 shadow-inner">
            <span id="resScore">0</span>ì 
          </div>
          <div class="mt-6 flex gap-2 justify-center">
            <button id="btnRestart" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-black">ë‹¤ì‹œ í’€ê¸°</button>
            <button id="btnGoWrong" class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">ì˜¤ë‹µë§Œ í’€ê¸°</button>
          </div>
        </div>
      </section>

      <!-- ì˜¤ë‹µë…¸íŠ¸ -->
      <section id="review" class="hidden">
        <h2 class="text-xl font-bold mb-3">ì˜¤ë‹µë…¸íŠ¸</h2>
        <div id="reviewList" class="space-y-3"></div>
      </section>
    </main>
  </div>

  <!-- ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ -->
  <dialog id="dlg" class="w-full max-w-4xl rounded-2xl border p-0 shadow-2xl backdrop:bg-black/20">
    <form method="dialog" class="p-0">
      <div class="p-4 border-b bg-slate-50 flex items-center justify-between">
        <h3 class="font-semibold">Q1~Q100 ì›ë¬¸ ë¶™ì—¬ë„£ê¸°</h3>
        <button class="px-3 py-1 text-sm rounded bg-slate-200 hover:bg-slate-300">ë‹«ê¸°</button>
      </div>
      <div class="p-4">
        <textarea id="paste" class="w-full h-64 p-3 border rounded-lg font-mono text-xs" placeholder="ì—¬ê¸°ì— Q1~Q100 ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#10;ì˜ˆ) Q1 ... (1) ... (2) ... (3) ... (4) ...&#10;ì •ë‹µ: â‘¢&#10;í•´ì„¤: ...&#10;Q2 ..."></textarea>
        <div class="mt-3 flex items-center justify-between">
          <div class="text-xs text-slate-500">
            â€¢ ë™ê·¸ë¼ë¯¸ ìˆ«ì(â‘ â‘¡â‘¢â‘£), ì¼ë°˜ ìˆ«ì(1~4) ëª¨ë‘ ì¸ì‹<br/>
            â€¢ â€˜í•´ì„¤:â€™ì€ ë‹¤ìŒ ë¬¸ì œ ì‹œì‘ ì „ê¹Œì§€ë¥¼ í•´ì„¤ë¡œ ì¸ì‹
          </div>
          <div class="flex gap-2">
            <button id="btnParse" type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ê°€ì ¸ì˜¤ê¸°</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

<script>
/* ===========================
  ìœ í‹¸
=========================== */
const $$ = sel => document.querySelector(sel);
const $$$ = sel => Array.from(document.querySelectorAll(sel));
const circledToNum = (s) => {
  // â‘ -â‘© ìœ ë‹ˆì½”ë“œ ëŒ€ì‘
  const map = { "â‘ ":1,"â‘¡":2,"â‘¢":3,"â‘£":4,"â‘¤":5,"â‘¥":6,"â‘¦":7,"â‘§":8,"â‘¨":9,"â‘©":10 };
  if (map[s]) return map[s];
  // ìˆ«ì ë¬¸ìì—´
  const m = String(s).match(/\d+/);
  return m ? parseInt(m[0],10) : NaN;
};
const chapterByQ = (qnum) => {
  if (qnum<=10) return "ì œ6ê°•";
  if (qnum<=20) return "ì œ7ê°•";
  if (qnum<=30) return "ì œ8ê°•";
  if (qnum<=40) return "ì œ9ê°•";
  if (qnum<=50) return "ì œ10ê°•";
  if (qnum<=60) return "ì œ11ê°•";
  if (qnum<=70) return "ì œ12ê°•";
  if (qnum<=80) return "ì œ13ê°•";
  if (qnum<=90) return "ì œ14ê°•";
  return "ì œ15ê°•";
};
const shuffle = (a) => {
  const arr = a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
};
const save = (key, val) => {
  try {
    localStorage.setItem(key, JSON.stringify(val));
  } catch(e) {
    console.warn("localStorage ì €ì¥ ì‹¤íŒ¨:", e);
  }
};
const load = (key, fallback=null) => {
  try{
    const v = localStorage.getItem(key);
    return v?JSON.parse(v):fallback
  }catch(e){
    console.warn("localStorage ë¡œë“œ ì‹¤íŒ¨:", e);
    return fallback
  }
}
const download = (filename, text) => {
  const blob = new Blob(["\uFEFF"+text], {type:"text/csv;charset=utf-8;"}); // UTF-8 BOM ì¶”ê°€
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
};
// ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½
const customAlert = (msg) => {
    // ì´ë¯¸ ì•Œë¦¼ì°½ì´ ìˆìœ¼ë©´ ë¬´ì‹œ
    if ($$("#customAlert")) return;
    const alertBox = document.createElement("div");
    alertBox.id = "customAlert";
    alertBox.className = "fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in";
    alertBox.textContent = msg;
    document.body.appendChild(alertBox);
    setTimeout(() => {
        alertBox.style.animation = "fade-out 0.3s ease forwards";
        setTimeout(() => alertBox.remove(), 300);
    }, 2500);
    // Fade-out ì• ë‹ˆë©”ì´ì…˜
    if (!document.getElementById("customAlertStyles")) {
        const style = document.createElement("style");
        style.id = "customAlertStyles";
        style.innerHTML = `@keyframes fade-out { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -10px); } }`;
        document.head.appendChild(style);
    }
};
// ì»¤ìŠ¤í…€ í™•ì¸ì°½
const customConfirm = (msg) => {
  return new Promise((resolve) => {
    const dialog = document.createElement("dialog");
    dialog.id = "customConfirmDialog";
    dialog.className = "w-full max-w-sm rounded-2xl border p-0 shadow-2xl backdrop:bg-black/30 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50";
    dialog.innerHTML = `
      <form method="dialog" class="p-0">
        <div class="p-5">
          <p class="text-slate-800 text-center">${msg}</p>
        </div>
        <div class="p-3 bg-slate-50 flex justify-end gap-2 border-t">
          <button id="confirmCancel" class="px-4 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">ì·¨ì†Œ</button>
          <button id="confirmOk" class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700">í™•ì¸</button>
        </div>
      </form>
    `;
    document.body.appendChild(dialog);
    dialog.showModal();
    $$("#confirmOk").addEventListener("click", () => {
      dialog.close();
      dialog.remove();
      resolve(true);
    });
    $$("#confirmCancel").addEventListener("click", () => {
      dialog.close();
      dialog.remove();
      resolve(false);
    });
    dialog.addEventListener("close", () => {
        dialog.remove();
        resolve(false);
    });
  });
};


/* ===========================
  ë°ì´í„°(í…ŒìŠ¤íŠ¸ìš© ì†Œìˆ˜) + ìƒíƒœ
=========================== */
let bank = load("swp_bank"); // ì „ì²´ ì›ì²œ(íŒŒì‹± ê²°ê³¼)
let run = load("swp_run");   // í˜„ì¬ ì„¸ì…˜ ì§„í–‰ìƒíƒœ

// í…ŒìŠ¤íŠ¸ìš© 3ë¬¸í•­(ë¶™ì—¬ë„£ê¸° ì—†ì´ë„ ë™ì‘ í™•ì¸ ê°€ëŠ¥)
const demoBank = [
  {id:1, chapter:"ì œ6ê°•", q:"ì •ì±…ê³¼ì • 5ë‹¨ê³„ ëª¨í˜•ì„ ì˜³ê²Œ ë‚˜ì—´í•œ ê²ƒì€?", options:["ì˜ì œâ†’ê²°ì •â†’ëŒ€ì•ˆâ†’ì§‘í–‰â†’í‰ê°€","ì‚¬íšŒë¬¸ì œâ†’ê²°ì •â†’ëŒ€ì•ˆâ†’ì§‘í–‰â†’í‰ê°€","ì˜ì œâ†’ëŒ€ì•ˆâ†’ê²°ì •â†’ì§‘í–‰â†’í‰ê°€","ì‚¬íšŒë¬¸ì œâ†’ì˜ì œâ†’ê²°ì •â†’ì§‘í–‰â†’í™˜ë¥˜"], answer:2, exp:"ì˜ì œâ†’ëŒ€ì•ˆí˜•ì„± ë° ë¶„ì„â†’ê²°ì •â†’ì§‘í–‰â†’í‰ê°€."},
  {id:2, chapter:"ì œ7ê°•", q:"ë§Œì¡±ëª¨í˜•(Satisficing)ì˜ í•µì‹¬ì€?", options:["ì™„ì „ í•©ë¦¬ì„±","ì ì¦ì£¼ì˜","ì´ˆí•©ë¦¬ì„±","ì¶©ë¶„íˆ ë§Œì¡±ìŠ¤ëŸ° ëŒ€ì•ˆ ì„ íƒ"], answer:3, exp:"ì œí•œëœ í•©ë¦¬ì„±í•˜ì—ì„œ ì¶©ë¶„íˆ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ëŒ€ì•ˆì„ ì„ íƒ."},
  {id:3, chapter:"ì œ8ê°•", q:"ê°€ì¹˜ì¬(Merit Goods)ì— í•´ë‹¹í•˜ëŠ” ê²ƒì€?", options:["ê³µì› ë“± ê³µê³µì¬","ì™„ì „ ì‚¬ì ì¬","ê³µêµìœ¡Â·ê³µê³µì„ëŒ€ ë“±","ì—´ë“±ì¬"], answer:2, exp:"ê°€ì¹˜ì¬ëŠ” ì˜¨ì •ì  ê°„ì„­ì£¼ì˜ í•˜ì— ì‚¬íšŒì ìœ¼ë¡œ ë°”ëŒì§í•œ ìˆ˜ì¤€ìœ¼ë¡œ ì œê³µ."},
];

if(!bank || bank.length === 0){ bank = demoBank; save("swp_bank", bank); }

/* ===========================
  íŒŒì„œ: ë¶™ì—¬ë„£ì€ Q1~Q100 â†’ êµ¬ì¡°í™”
=========================== */
function parsePasted(text){
  const lines = text.replace(/\r/g,'').split('\n');

  const items = [];
  let i=0; let curr=null;
  let lineErrors = [];

  function pushCurr(){
    if(!curr) return;
    if(curr.options.length!==4) {
        lineErrors.push(`Q${curr.id} ì„ íƒì§€ê°€ 4ê°œê°€ ì•„ë‹™ë‹ˆë‹¤. (í˜„ì¬ ${curr.options.length}ê°œ)`);
    }
    if(typeof curr.answer!=="number") {
        lineErrors.push(`Q${curr.id} ì •ë‹µì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
    }
    if(!curr.exp) curr.exp="";
    items.push(curr);
    curr=null;
  }

  while(i<lines.length){
    let line = lines[i].trim();

    // ìƒˆ ë¬¸ì œ ì‹œì‘: Qìˆ«ì ê³µë°± ë’¤ í…ìŠ¤íŠ¸
    let mQ = line.match(/^Q\s?(\d+)\s+(.+)$/) || line.match(/^Q(\d+)\s+(.+)$/);
    if(mQ){
      // ì´ì „ ë¬¸ì œ ì €ì¥
      pushCurr();
      const qnum = parseInt(mQ[1],10);
      curr = { id:qnum, chapter:chapterByQ(qnum), q:mQ[2].trim(), options:[], answer:undefined, exp:"" };
      i++; continue;
    }

    // ì„ íƒì§€ (1)~(4) ë˜ëŠ” â‘ ~â‘£
    let mOpt = line.match(/^\((\d)\)\s*(.+)$/) || line.match(/^([â‘ â‘¡â‘¢â‘£])\s*(.+)$/);
    if(mOpt && curr){
      const idx = circledToNum(mOpt[1]) - 1;
      if (idx >= 0 && idx < 4) {
        curr.options[idx] = mOpt[2].trim();
      }
      i++; continue;
    }

    // ì •ë‹µ: â‘¢ ë˜ëŠ” 3
    let mAns = line.match(/^ì •ë‹µ\s*[:ï¼š]\s*([â‘ â‘¡â‘¢â‘£]|\d)/);
    if(mAns && curr){
      const a = circledToNum(mAns[1]);
      curr.answer = a-1; // 0-based
      i++; continue;
    }

    // í•´ì„¤: ~ (ë‹¤ìŒ Q ì „ê¹Œì§€ ëˆ„ì )
    let mExp = line.match(/^í•´ì„¤\s*[:ï¼š]\s*(.*)$/);
    if(mExp && curr){
      let exp = mExp[1];
      i++;
      // ë‹¤ìŒ Q ì „ê¹Œì§€ ì´ì–´ë¶™ì´ê¸°
      while(i<lines.length && !/^Q\s?\d+/.test(lines[i].trim())){
        // í•´ì„¤ì´ ì—†ëŠ” ê²½ìš° ì •ë‹µ ë¼ì¸ì´ ë¶™ì–´ìˆì„ ìˆ˜ ìˆìŒ.
        if (!lines[i].trim().startsWith("ì •ë‹µ")) {
            exp += "\n" + lines[i];
        }
        i++;
      }
      curr.exp = exp.trim();
      continue;
    }
    
    // í˜„ì¬ ë¬¸ì œì— ì†í•´ìˆì§€ë§Œ ìœ„ íŒ¨í„´ì— ê±¸ë¦¬ì§€ ì•Šì€ ë¼ì¸ ì²˜ë¦¬
    if(curr && line) {
        // (1)~(4) ë˜ëŠ” â‘ ~â‘£ íŒ¨í„´ì´ ì•„ë‹Œë° ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (e.g. 1. 2. 3. 4.)
        let mOptNum = line.match(/^(\d)[\.ï¼]\s*(.+)$/);
        if (mOptNum) {
            const idx = parseInt(mOptNum[1], 10) - 1;
             if (idx >= 0 && idx < 4) {
                curr.options[idx] = mOptNum[2].trim();
             }
             i++; continue;
        }
        
        // í•´ì„¤ì´ ì´ë¯¸ ì‹œì‘ëœ ê²½ìš°, ì´ì–´ë¶™ì„
        if(curr.exp) {
            curr.exp += "\n" + line;
        }
    }

    i++;
  }
  // ë§ˆì§€ë§‰ ë¬¸ì œ ì €ì¥
  pushCurr();

  // ê²€ì¦
  if(items.length<1) throw new Error("ë¬¸í•­ì„ í•˜ë‚˜ë„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì›ë¬¸ í˜•ì‹(Q1 â€¦, (1) â€¦, ì •ë‹µ:, í•´ì„¤:)ì„ í™•ì¸í•˜ì„¸ìš”.");
  
  // íŒŒì‹± ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì¼ë‹¨ ì§„í–‰í•˜ê³ , ì˜¤ë¥˜ ë³´ê³ 
  if (lineErrors.length > 0) {
      console.warn("íŒŒì‹± ì˜¤ë¥˜:\n" + lineErrors.join("\n"));
      customAlert(`íŒŒì‹± ì¤‘ ${lineErrors.length}ê°œ í•­ëª©ì—ì„œ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†” í™•ì¸)`);
  }

  items.forEach(it=>{
    if(it.options.some(o=>!o)) {
        console.warn(`Q${it.id} ì„ íƒì§€ì— ë¹ˆ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.`);
        // ë¹ˆ í•­ëª© ì±„ìš°ê¸°
        it.options = it.options.map((o, idx) => o || `(ì„ íƒì§€ ${idx+1} ëˆ„ë½)`);
    }
    if(isNaN(it.answer) || it.answer<0 || it.answer>3) {
        console.warn(`Q${it.id} ì •ë‹µ ì¸ì‹ ì‹¤íŒ¨`);
        it.answer = 0; // ì˜¤ë¥˜ ì‹œ ì²« ë²ˆì§¸ í•­ëª©ì„ ì„ì‹œ ì •ë‹µìœ¼ë¡œ
    }
  });

  // id ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  items.sort((a,b)=>a.id-b.id);
  return items;
}

/* ===========================
  ë Œë”/ì§„í–‰
=========================== */
function newRun(allBank, filterChap="all", mode="shuffle"){
  let pool = allBank;
  if(filterChap!=="all"){
    pool = pool.filter(x=>x.chapter===filterChap);
  }
  if(pool.length===0) throw new Error("ì„ íƒí•œ ì±•í„°ì— ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
  let order = pool.map((_,idx)=>idx);
  if(mode==="shuffle") order = shuffle(order);
  return {
    ts: Date.now(),
    filterChap, mode,
    pool,
    order,
    idx: 0,
    done: [], // {qid, correct, pick}
    score: 0
  };
}
function currentItem(r){ return r.pool[r.order[r.idx]] }

function renderProgress(){
  if (!run || !run.pool) return;
  const total = run.pool.length;
  const cur = Math.min(run.idx, total);
  $$("#progressText").textContent = `ì§„í–‰ ${cur} / ${total}`;
  $$("#chapterText").textContent = `${run.filterChap==="all"?"ì „ì²´":run.filterChap} â€¢ ${run.mode==="shuffle"?"ë¬´ì‘ìœ„":"ìˆœì„œ"}`;
  const pct = total? Math.round(cur/total*100) : 0;
  $$("#progressBar").style.width = pct+"%";
}
function showSection(id){
  ["welcome","quiz","result","review"].forEach(s=>{
    const el = $$("#"+s);
    if (el) el.classList.add("hidden");
  });
  const targetEl = $$("#"+id);
  if (targetEl) targetEl.classList.remove("hidden");
}
function renderQuestion(){
  if (!run || !currentItem(run)) {
      customAlert("ì˜¤ë¥˜: í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      showSection("welcome");
      return;
  }
  const it = currentItem(run);
  renderProgress();
  $$("#qTitle").textContent = `Q${it.id}. ${it.q}`;
  $$("#metaText").textContent = `${it.chapter} â€¢ Q${run.idx+1}/${run.pool.length}`;
  const opts = $$("#options");
  opts.innerHTML = "";
  $$("#explain").classList.add("hidden");
  // ì˜µì…˜
  it.options.forEach((text, i)=>{
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="option w-full text-left px-4 py-3 rounded-xl border bg-white hover:bg-slate-50";
    btn.innerHTML = `<span class="font-semibold mr-2">${i+1}.</span>${text.replace(/</g, "&lt;")}`;
    btn.addEventListener("click",()=>pickAnswer(i));
    opts.appendChild(btn);
  });
  // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ í™œì„±í™”
  $$("#btnNext").disabled = true;
  $$("#btnNext").classList.add("opacity-50", "cursor-not-allowed");
}
function pickAnswer(i){
  const it = currentItem(run);
  const btns = $$$("#options .option");
  // ì´ë¯¸ ì„ íƒí–ˆë‹¤ë©´ ë¦¬í„´
  if (btns[0] && btns[0].disabled) return;
  
  btns.forEach((b,idx)=>{
    b.disabled = true;
    if(idx===it.answer) b.classList.add("correct");
    if(idx===i && i!==it.answer) b.classList.add("incorrect");
  });
  // í•´ì„¤
  $$("#explainText").textContent = `ì •ë‹µ: (${it.answer+1})\n\n${it.exp||"í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}`;
  $$("#explain").classList.remove("hidden");

  const correct = (i===it.answer);
  run.done.push({ qid: it.id, correct, pick: i });
  if(correct) run.score += 1;
  save("swp_run", run);
  
  // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ í™œì„±í™”
  $$("#btnNext").disabled = false;
  $$("#btnNext").classList.remove("opacity-50", "cursor-not-allowed");
}
function nextQuestion(){
  // ë‹µì„ ì„ íƒí•´ì•¼ ë„˜ì–´ê°
  if ($$("#btnNext").disabled) {
      customAlert("ë‹µì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
      return;
  }

  if(run.idx < run.pool.length-1){
    run.idx += 1;
    save("swp_run", run);
    renderQuestion();
  }else{
    // ê²°ê³¼
    showSection("result");
    const total = run.pool.length;
    $$("#resTotal").textContent = total;
    $$("#resCorrect").textContent = run.score;
    const score100 = total > 0 ? Math.round(run.score/total*100) : 0;
    $$("#resScore").textContent = score100;
    save("swp_run", run);
  }
}
function restartWrongOnly(){
  const wrongIds = run.done.filter(d=>!d.correct).map(d=>d.qid);
  if(wrongIds.length===0){ customAlert("ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!"); return; }
  const pool = bank.filter(b=>wrongIds.includes(b.id));
  run = {
    ts: Date.now(),
    filterChap: "ì˜¤ë‹µ",
    mode: "shuffle",
    pool,
    order: shuffle(pool.map((_,i)=>i)),
    idx: 0, done: [], score: 0
  };
  save("swp_run", run);
  showSection("quiz");
  renderQuestion();
}
function renderReview(){
  showSection("review");
  const list = $$("#reviewList");
  list.innerHTML = "";
  
  const doneItems = (run && run.done) ? run.done : [];
  const wrong = doneItems.filter(d=>!d.correct);
  
  if(wrong.length===0){
    list.innerHTML = `<div class="p-4 bg-emerald-50 border rounded text-emerald-800">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‘</div>`;
    return;
  }
  
  wrong.forEach(w=>{
    const it = bank.find(x=>x.id===w.qid);
    if (!it) return; // ì›ë³¸ bankì—ì„œ ëª»ì°¾ëŠ” ê²½ìš° ìŠ¤í‚µ
    
    const box = document.createElement("div");
    box.className="p-4 border rounded-lg bg-white shadow-sm";
    box.innerHTML = `
      <div class="text-sm text-slate-500 mb-1">${it.chapter} â€¢ Q${it.id}</div>
      <div class="font-semibold mb-2">${it.q.replace(/</g, "&lt;")}</div>
      <ul class="text-sm mb-3 space-y-1">
        ${it.options.map((o,idx)=>`
          <li class="${idx===it.answer?'font-semibold text-emerald-700':'text-slate-700'} ${idx===w.pick?'opacity-70':''}">
            <span class="inline-block w-6">(${idx+1})</span> ${o.replace(/</g, "&lt;")}
            ${idx===w.pick?' <span class="text-rose-600 font-semibold ml-2">â† ë‚´ ì„ íƒ</span>':''}
            ${idx===it.answer?' <span class="text-emerald-600 font-semibold ml-2">â† ì •ë‹µ</span>':''}
          </li>`).join("")}
      </ul>
      <div class="text-sm bg-blue-50 border border-blue-200 rounded p-3 whitespace-pre-wrap leading-relaxed"><b>í•´ì„¤:</b>\n${it.exp||"í•´ì„¤ ì—†ìŒ"}</div>
    `;
    list.appendChild(box);
  });
}

/* ===========================
  ì´ë²¤íŠ¸
=========================== */
$$("#btnStart").addEventListener("click", ()=>{
  try{
    const chap = $$("#filterChapter").value;
    const mode = $$("#modeSelect").value;
    run = newRun(bank, chap, mode);
    save("swp_run", run);
    showSection("quiz");
    renderQuestion();
  }catch(e){
    customAlert(e.message);
  }
});
$$("#btnNext").addEventListener("click", nextQuestion);
$$("#btnRestart").addEventListener("click", ()=>{
  const chap = (run && run.filterChap==="ì˜¤ë‹µ") ? "all" : (run ? run.filterChap : "all");
  const mode = "shuffle";
  try {
    run = newRun(bank, chap, mode);
    save("swp_run", run);
    showSection("quiz");
    renderQuestion();
  } catch(e) {
    customAlert(e.message);
  }
});
$$("#btnGoWrong").addEventListener("click", restartWrongOnly);
$$("#btnReview").addEventListener("click", ()=>{
  if(!run || !run.done?.length){ customAlert("ë¨¼ì € í€´ì¦ˆë¥¼ 1íšŒ ì´ìƒ ì™„ë£Œí•´ ì£¼ì„¸ìš”."); return; }
  renderReview();
});
$$("#btnExport").addEventListener("click", ()=>{
  if(!run || !run.done?.length){ customAlert("ë¨¼ì € í€´ì¦ˆë¥¼ ì§„í–‰í•´ ì£¼ì„¸ìš”."); return; }
  const rows = [["qid","chapter","question","my_pick(1-4)","answer(1-4)","is_correct(1/0)"]];
  run.done.forEach(d=>{
    const it = bank.find(x=>x.id===d.qid);
    if (!it) return;
    rows.push([
        it.id, 
        it.chapter, 
        `"${(it.q||"").replace(/"/g,'""')}"`, // ì§ˆë¬¸ ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
        d.pick+1, 
        it.answer+1, 
        d.correct ? 1 : 0
    ]);
  });
  const csv = rows.map(r=>r.join(",")).join("\n");
  download(`ê²°ê³¼_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`, csv);
});
$$("#btnImport").addEventListener("click", ()=>{ $$("#dlg").showModal(); });
$$("#btnParse").addEventListener("click", ()=>{
  const raw = $$("#paste").value;
  if(!raw.trim()){ customAlert("í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”."); return; }
  try{
    const parsed = parsePasted(raw);
    bank = parsed;
    save("swp_bank", bank);
    $$("#dlg").close();
    customAlert(`ì´ ${bank.length}ë¬¸í•­ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤! ì´ì œ 'ì‹œì‘'ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.`);
    // ì¬ê°œë²„íŠ¼ ê°±ì‹ 
    const hasRun = !!load("swp_run");
    $$("#btnResume").classList.toggle("hidden", !hasRun);
    // ì›°ì»´ í™”ë©´ìœ¼ë¡œ
    showSection("welcome");
  }catch(e){
    customAlert("íŒŒì‹± ì˜¤ë¥˜: " + e.message);
  }
});
$$("#btnReset").addEventListener("click", async ()=>{
  const confirmed = await customConfirm("ì§„í–‰ìƒí™©ê³¼ ì €ì¥ëœ ë¬¸ì œ ì€í–‰(ë¶™ì—¬ë„£ê¸° ê²°ê³¼)ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?");
  if(confirmed){
    localStorage.removeItem("swp_bank");
    localStorage.removeItem("swp_run");
    bank = demoBank.slice();
    run = null;
    customAlert("ì´ˆê¸°í™” ì™„ë£Œ. ë°ëª¨ ë°ì´í„°ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
    setTimeout(()=>location.reload(), 500);
  }
});
$$("#btnResume").addEventListener("click", ()=>{
  const r = load("swp_run");
  if(!r){ customAlert("ì¬ê°œí•  ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  run = r;
  
  if (run.idx >= run.pool.length) {
      // ì´ë¯¸ ì™„ë£Œëœ ì„¸ì…˜
      showSection("result");
      const total = run.pool.length;
      $$("#resTotal").textContent = total;
      $$("#resCorrect").textContent = run.score;
      const score100 = total > 0 ? Math.round(run.score/total*100) : 0;
      $$("#resScore").textContent = score100;
  } else {
      // ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜
      showSection("quiz");
      renderQuestion();
  }
});

// í‚¤ë³´ë“œ(1~4,N)
window.addEventListener("keydown",(e)=>{
  // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì¤‘ì§€
  if ($$("#dlg").open || $$("#customConfirmDialog")) return;

  const onQuiz = !$$("#quiz").classList.contains("hidden");
  if(!onQuiz || !run) return;
  
  if(["1","2","3","4"].includes(e.key)){
    e.preventDefault();
    const idx = parseInt(e.key,10)-1;
    const btns = $$$("#options .option");
    if(btns[idx] && !btns[idx].disabled) btns[idx].click();
  }else if(e.key.toLowerCase()==="n" || e.key === "Enter" || e.key === "ArrowRight"){
    e.preventDefault();
    $$("#btnNext").click();
  }
});

/* ===========================
  ì´ˆê¸° í‘œì‹œ
=========================== */
(function init(){
  const hasRun = !!load("swp_run");
  $$("#btnResume").classList.toggle("hidden", !hasRun);
  showSection("welcome");
})();
</script>
</body>
</html>
